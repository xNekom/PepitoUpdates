name: Check Pepito Status

on:
  schedule:
    # Ejecutar cada 2 minutos
    - cron: '*/2 * * * *'
  workflow_dispatch: # Permitir ejecuciÃ³n manual

jobs:
  check-pepito-status:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check Pepito Status
      run: |
        echo "ğŸ”„ Verificando estado de PÃ©pito..."

        # URL de la Edge Function de Supabase (reemplaza con tu URL real)
        EDGE_FUNCTION_URL="${{ secrets.SUPABASE_EDGE_FUNCTION_URL }}"

        if [ -z "$EDGE_FUNCTION_URL" ]; then
          echo "âŒ Error: SUPABASE_EDGE_FUNCTION_URL no estÃ¡ configurado en los secrets"
          exit 1
        fi

        # Hacer la peticiÃ³n a la Edge Function
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          "$EDGE_FUNCTION_URL")

        # Extraer el cÃ³digo de estado HTTP (Ãºltima lÃ­nea)
        http_code=$(echo "$response" | tail -n1)
        # Extraer el cuerpo de la respuesta (todo menos la Ãºltima lÃ­nea)
        body=$(echo "$response" | head -n -1)

        echo "ğŸ“¡ CÃ³digo de respuesta: $http_code"
        echo "ğŸ“„ Respuesta: $body"

        if [ "$http_code" -eq 200 ]; then
          echo "âœ… Estado de PÃ©pito verificado exitosamente"

          # Parsear la respuesta JSON para mostrar informaciÃ³n Ãºtil
          status=$(echo "$body" | jq -r '.status // "unknown"')
          description=$(echo "$body" | jq -r '.description // "Sin descripciÃ³n"')
          inserted=$(echo "$body" | jq -r '.inserted // false')

          echo "ğŸ“Š Estado: $status"
          echo "ğŸ“ DescripciÃ³n: $description"
          echo "ğŸ’¾ Insertado en BD: $inserted"
        else
          echo "âŒ Error al verificar estado de PÃ©pito"
          echo "ğŸ” Respuesta completa: $body"
          exit 1
        fi